name: CI/CD Pipeline
# This workflow is triggered on pushes to the repository.
on: push

jobs:
    test:
        name: Test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-python@v2
              with:
                python-version: '2.7'
            - run: sudo service mysql stop # Shutdown the Default MySQL, "sudo" is necessary
            - run: pip install -r pip-requirements.txt
            - run: |
                sudo apt-get install -y mysql-client
                mysql --host 127.0.0.1 --port ${{ job.services.db.ports['3306'] }} -u openshiksha_app -p Soc1alsev@ -e "SHOW DATABASES"
            - run: scripts/testing/unit.sh
              env:
                OPENSHIKSHA_ENV: PROD
                OPENSHIKSHA_SECRET_KEY: "!x5@#nf^s53jwqx)l%na@=*!(1x+=jr496_yq!%ekh@u0pp1+n"
                OPENSHIKSHA_DB_PASSWORD: "Soc1alsev@"
                OPENSHIKSHA_DB_HOST: "127.0.0.1"
                OPENSHIKSHA_DB_PORT: ${{ job.services.db.ports['3306'] }}
        services:
            db:
                image: mysql:8
                ports:
                  - 3306
                env:
                    MYSQL_USER: openshiksha_app
                    MYSQL_PASSWORD: "Soc1alsev@"
                options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    build-deploy:
        name: Build & Deploy
        needs: test
        # only run this on qa & prod branches
        if: github.ref == 'refs/heads/qa' || github.ref == 'refs/heads/prod'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/setup-python@v2
              with:
                python-version: '2.7'
            - run: which python && which pip



